<!DOCTYPE HTML>
<html>	
	<head>	
		<meta charset="UTF-8" />
		<link rel="stylesheet" type="text/css" href="styles.css" />	    
		<link rel="stylesheet" type="text/css" href="rickshaw.min.css" />	    
		<script src="vendor/d3.v3.js" charset="utf-8"></script>   
		<script src="vendor/jquery-1.11.0.min.js" charset="utf-8"></script>   
		<script src="rickshaw.js"></script>	 
		<style>
			body
			{
				padding: 0;
				margin: 0;
				overflow: hidden;
			}
			
			div#chart 
			{ 
				width: 100%;
				height: 100%;
				background: #80000;
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<div id="chart"></div>
		<script type="text/javascript">
			var values = VALUES_JSON;

			var mapper = function(d) 
			{
				return { x: d.x / 1000, y: d.y + 0.1};
			};

			Rickshaw.Graph.Renderer.CustomBars = Rickshaw.Class.create( Rickshaw.Graph.Renderer.Bar, {
				name: 'custom-bars',
				stack: false,
				barWidth: function(series) {
					return 2;
				},
				defaults: function($super) 
				{
					var defaults = Rickshaw.extend( $super(), {
						gapSize: 0.05,
						unstack: true
					});

					delete defaults.tension;
					return defaults;
				}
			});
			
			$(document).ready(function()
			{
				$.each(values, function(index, value) 
				{
					value.name = value.key;
					value.data = value.values.map(mapper);
				});

				var xMin = null;
				var xMax = null;
				var yMin = null;
				var yMax = null;

				$.each(values, function(index, value) 
				{
					value.name = value.key;
					value.data = value.values.map(mapper);
					
					$.each(value.data, function(index, value)
					{
						var x = value.x;
						var y = value.y;
						
						if (xMin == null || x < xMin)
							xMin = x;
							
						if (yMin == null || y < yMin)
							yMin = y;
					
						if (xMax == null || x > xMax)
							xMax = x;
							
						if (yMax == null || y > yMax)
							yMax = y;
					});
				});
				
				var xSpace = (xMax - xMin) / 8;
				var ySpace = (yMax - yMin) / 10;
				
				var border = {
					color: "rgba(1, 0, 0, 0)",
					key: "Buffer",
					name: "Buffer",
					renderer: "line",
					data: [
						{
							y: (yMax + ySpace),
							x: (xMin - xSpace) 
						},
						{
							y: 0,
							x: (xMax + xSpace)
						}
					]
				};
				
				values.splice(0, 0, border);

				var graph = new Rickshaw.Graph({
					renderer: "multi",
					element: document.getElementById("chart"),
					height: $(window).height(),
					width: $(window).width(),
					dotSize: 7,
					series: values
				});
				
				graph.render();

				var time = new Rickshaw.Fixtures.Time();
				var timeUnit = time.unit("week");
				
				var xAxis = new Rickshaw.Graph.Axis.Time({ 
					graph: graph,
					timeUnit: timeUnit
				});
				xAxis.render();

				var detail = new Rickshaw.Graph.HoverDetail({
					graph: graph,
					formatter: function(series, x, y, formattedX, formattedY, d) 
					{
						if (series.name == "Buffer")
							return null;
							
						return series.name + ':&nbsp;' + (series.base + ((formattedY - 0.1) * series.multiplier)).toFixed(2) + series.unit;
					},
					onShow: function(args)
					{
						console.log("ARGS: " + JSON.stringify(args));
					}
				});
			});
		</script>
	</body>
</html>